version: "3.8" # Versi docker-compose yang digunakan

services: # Daftar container yang akan dijalankan
    app: # Service utama untuk Laravel (PHP-FPM)
        build: # Instruksi untuk build image dari Dockerfile
            context: . # Folder project sebagai sumber build
            dockerfile: Dockerfile # File Dockerfile yang digunakan

        container_name: laravel_app # Nama container agar mudah dikenali
        restart: unless-stopped # Restart container kecuali dihentikan manual

        working_dir: /var/www/html # Direktori kerja default dalam container

        volumes:
            - .:/var/www/html # Mount seluruh project ke dalam container
            - ./storage:/var/www/html/storage # Pastikan folder storage writable
            - ./bootstrap/cache:/var/www/html/bootstrap/cache # Mount cache Laravel

        environment: # Variable environment untuk Laravel
            - APP_ENV=production # Mode environment Laravel
            - APP_DEBUG=false # Disable debug mode
            - DB_CONNECTION=mysql # Opsi driver database
            - DB_HOST=db # Host database dengan nama service db
            - DB_PORT=3306 # Port database
            - DB_DATABASE=laravel # Nama database
            - DB_USERNAME=user # User database
            - DB_PASSWORD=password123 # Password database

        networks:
            - laravel # Menghubungkan service ke network "laravel"

        depends_on:
            - db # Pastikan db dijalankan dahulu sebelum app

    nginx: # Service untuk web server Nginx
        image: nginx:alpine # Menggunakan image nginx versi ringan
        container_name: laravel_nginx # Nama container untuk Nginx
        restart: unless-stopped # Restart otomatis jika container mati

        ports:
            - "80:80" # Map port 80 host â†’ port 80 container

        volumes:
            - .:/var/www/html # Mount seluruh project ke nginx
            - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf
              # Konfigurasi custom untuk Nginx

        depends_on:
            - app # Menunggu Laravel (app) aktif terlebih dahulu

        networks:
            - laravel # Menghubungkan service ke network laravel

    db: # Service untuk database MariaDB
        image: mariadb:10.11 # Image MariaDB versi 10.11
        container_name: laravel_db # Nama container database
        restart: unless-stopped # Restart otomatis jika terjadi crash

        environment: # Variable environment database
            MARIADB_DATABASE: laravel # Nama database default
            MARIADB_USER: user # User database
            MARIADB_PASSWORD: password123 # Password user
            MARIADB_ROOT_PASSWORD: root123 # Password root

        command:
            --default-authentication-plugin=mysql_native_password
            # Gunakan plugin auth agar kompatibel dengan MySQL

        ports:
            - "3306:3306" # Expose port DB ke host (opsional)

        volumes:
            - db_data:/var/lib/mysql # Volume untuk menyimpan data database (persisten)

        networks:
            - laravel # Menghubungkan service db dengan jaringan laravel

networks:
    laravel:
        driver: bridge # Gunakan driver bridge (default docker networking)

volumes:
    db_data:
        driver: local # Volume penyimpanan lokal untuk MySQL
